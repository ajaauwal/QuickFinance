{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Main Content Section -->
<div class="main-container">
    <div class="right-panel">
        <h1 class="form-heading">Add Money</h1>

        <!-- Add Funds Form -->
        <form method="POST" id="paystackForm" class="form-container">
            {% csrf_token %}

            <div class="form-section">
                <label for="amount">Amount</label>
                <input type="number" name="amount" id="amount" class="form-control" placeholder="Enter amount to add" required>
            </div>

            <div class="form-section">
                <label for="transaction_type">Transaction Type</label>
                <select name="transaction_type" id="transaction_type" class="form-control" required>
                    <option value="">Select transaction type</option>
                    <option value="deposit">Deposit</option>
                    <option value="bonus">Bonus</option>
                    <option value="referral">Referral</option>
                </select>
            </div>

            <div class="form-section">
                <label for="transaction_description">Transaction Description</label>
                <input type="text" name="transaction_description" id="transaction_description" class="form-control" placeholder="Enter transaction description" required>
            </div>

            <button type="button" class="btn btn-primary" id="paystack-button">Add Fund</button>
        </form>

        <!-- Success and Error Messages -->
        <div id="alert-container" style="margin-top: 20px;"></div>
    </div>
</div>

<!-- Paystack Script -->
<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
document.getElementById("paystack-button").addEventListener("click", function(event) {
    event.preventDefault();

    const amount = document.getElementById("amount").value.trim();
    const transactionType = document.getElementById("transaction_type").value.trim();
    const transactionDescription = document.getElementById("transaction_description").value.trim();
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    if (!amount || !transactionType || !transactionDescription) {
        showAlert('Please fill all fields before proceeding.', 'danger');
        return;
    }

    var paystackPublicKey = "{{ paystack_public_key }}";

    var handler = PaystackPop.setup({
        key: paystackPublicKey,
        email: "{{ user.email }}",
        amount: parseInt(amount) * 100, // Convert to Kobo
        currency: "NGN",
        ref: "ref-" + Date.now(), // Unique reference
        metadata: {
            custom_fields: [
                {
                    display_name: "Transaction Type",
                    variable_name: "transaction_type",
                    value: transactionType
                },
                {
                    display_name: "Description",
                    variable_name: "transaction_description",
                    value: transactionDescription
                }
            ]
        },
        callback: function(response) {
            // Payment successful, now verify on server
            fetch("{% url 'transactions:verify_payment' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrfToken
                },
                body: new URLSearchParams({
                    reference: response.reference,
                    amount: amount,
                    transaction_type: transactionType,
                    transaction_description: transactionDescription
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showAlert(data.message, 'success');
                    document.getElementById("paystackForm").reset();
                } else if (data.error) {
                    showAlert(data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Something went wrong during verification.', 'danger');
            });
        },
        onClose: function() {
            showAlert("Payment process was cancelled.", 'danger');
        }
    });

    handler.openIframe();
});

// Function to show success or error messages
function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = `
        <div class="alert alert-${type}">
            ${message}
        </div>
    `;
}
</script>

<style>
/* Same CSS you posted â€” no changes needed */
.main-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background-color: #f7f7f736;
    padding: 20px;
}
.right-panel {
    background: #ffffff;
    border-radius: 8px;
    padding: 30px;
    box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.1);
    max-width: 400px;
    width: 100%;
}
.form-heading {
    font-size: 2rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 20px;
    text-align: center;
}
.form-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.form-section {
    display: flex;
    flex-direction: column;
}
.form-section label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #555;
    margin-bottom: 5px;
}
.form-control {
    padding: 12px;
    font-size: 1rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    transition: all 0.3s ease;
}
.form-control:focus {
    border-color: #0056b3;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 86, 179, 0.5);
}
.btn-primary {
    background-color: #0056b3;
    color: #fff;
    padding: 12px;
    font-size: 1rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
.btn-primary:hover {
    background-color: #003f8b;
}
.alert {
    padding: 15px;
    font-size: 0.875rem;
    margin-top: 20px;
    border-radius: 5px;
}
.alert-danger {
    background-color: #f8d7da;
    color: #721c24;
}
.alert-success {
    background-color: #d4edda;
    color: #155724;
}
</style>

{% endblock %}
